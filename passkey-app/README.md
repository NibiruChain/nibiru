# SAI Passkey Demo (browser)

Simple React/Vite UI to drive SAI's EVM interface using WebAuthn passkeys instead of MetaMask. It now ships with a
one-command setup that starts localnet, deploys EntryPoint + PasskeyAccountFactory, and pre-fills the UI config. The UI
now talks to an ERC-4337 bundler (not a custom RPC method) for passkey-signed user operations.

## Quickstart

```bash
# From nibiru/ root
just passkey-demo        # starts localnet (if needed), deploys EntryPoint + PasskeyAccountFactory, writes .env.local, starts bundler on :4337 (logs in logs/passkey-bundler.log)

# Then launch the UI
cd passkey-app && npm install && npm run dev
```

If you want to run the bundler manually instead of the background process from `just passkey-demo`, use:

```bash
cd evm-e2e/passkey-sdk
ENTRY_POINT=$(jq -r .entryPoint ../.cache/passkey-demo.json) \
FACTORY_ADDR=$(jq -r .passkeyFactory ../.cache/passkey-demo.json) \
JSON_RPC_ENDPOINT=http://127.0.0.1:8545 \
BUNDLER_PORT=4337 \
npm run bundler:local
```

Open http://localhost:5173. The connection panel is prefilled from `.env.local` (RPC, chain ID, factory). Add the
bundler URL if needed (defaults to http://127.0.0.1:4337). Flow:

1) Create/load a passkey (WebAuthn).  
2) Click “Create passkey account” — this asks the bundler to call `createAccount(qx,qy)` on the factory, then auto-sets
   `from` from the `AccountCreated` event.  
3) Bundler sponsorship is disabled. Fund that address manually if needed (e.g. `nibid tx bank send validator <passkey_addr> 1000000000000000000unibi --yes --fees 750000unibi --gas 300000 --chain-id nibiru-localnet-0 --node http://localhost:26657`).  
4) Use “Send NIBI (prefilled)” for a quick native transfer, or “Open custom transaction” for calldata trades.  
5) Deposit flow uses `PerpVaultEvmInterface.deposit`; fill vault address, collateral ERC20, and wasm msg if needed.

## Data passed to the RPC

When you click "Send" the app:

1. Builds an ERC-4337 UserOperation that wraps `PasskeyAccount.execute(to,value,data)`.
2. Creates a challenge hash (`getUserOpHash`) and asks your passkey to sign it via WebAuthn (P-256, r/s).
3. Posts the RPC-friendly UserOperation to the bundler (`eth_sendUserOperation`); the bundler relays it to EntryPoint.

The signature is encoded as `abi.encode(r,s)` for the on-chain P-256 precompile at 0x000...0100.

## Notes / TODO
- `.env.local` is generated by `just passkey-demo`. Delete it to reset defaults.
- `deposit` calldata comes from `@sai/evm-interface`'s `PerpVaultEvmInterface` ABI (trimmed into `src/lib/abi`).
- UserOps currently use a flat gas config; tune `callGasLimit`, `verificationGasLimit`, and `preVerificationGas` if your bundler/node requires different values.
